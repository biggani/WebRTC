function trace(n){n[n.length-1]=="\n"&&(n=n.substring(0,n.length-1));console.log((performance.now()/1e3).toFixed(3)+": "+n)}String.prototype.capitalize=function(){return this.replace(/(^|\s)([a-z])/g,function(n,t,i){return t+i.toUpperCase()})};var RTCPeerConnection=null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,webrtcDetectedVersion=null;navigator.mozGetUserMedia?(webrtcDetectedBrowser="firefox",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10),RTCPeerConnection=mozRTCPeerConnection,RTCSessionDescription=mozRTCSessionDescription,RTCIceCandidate=mozRTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),createIceServer=function(n,t,i){var r=null,f=n.split(":"),u;return f[0].indexOf("stun")===0?r={url:n}:f[0].indexOf("turn")===0&&(webrtcDetectedVersion<27?(u=n.split("?"),u[1].indexOf("transport=udp")===0&&(r={url:u[0],credential:i,username:t})):r={url:n,credential:i,username:t}),r},attachMediaStream=function(n,t){n.mozSrcObject=t;n.play()},reattachMediaStream=function(n,t){n.mozSrcObject=t.mozSrcObject;n.play()},MediaStream.prototype.getVideoTracks=function(){return[]},MediaStream.prototype.getAudioTracks=function(){return[]}):navigator.webkitGetUserMedia?(webrtcDetectedBrowser="chrome",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2],10),createIceServer=function(n,t,i){var r=null,u=n.split(":");return u[0].indexOf("stun")===0?r={url:n}:u[0].indexOf("turn")===0&&(r={url:n,credential:i,username:t}),r},RTCPeerConnection=webkitRTCPeerConnection,getUserMedia=navigator.webkitGetUserMedia.bind(navigator),attachMediaStream=function(n,t){typeof n.srcObject!="undefined"?n.srcObject=t:typeof n.mozSrcObject!="undefined"?n.mozSrcObject=t:typeof n.src!="undefined"?n.src=URL.createObjectURL(t):console.log("Error attaching stream to element.")},reattachMediaStream=function(n,t){n.src=t.src}):console.log("Browser does not appear to be WebRTC-capable");window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(n){window.setTimeout(n,1e3/60)}}();XSockets.PeerContext=function(n,t){this.PeerId=n;this.Context=t};window.AudioContext=window.AudioContext||window.webkitAudioContext;XSockets.AudioAnalyser=function(){function n(n,t,i){function o(n,t){var a=4,v=1e3,f=1e3,h=-1,s=0,e=0,y=0,c,o,u,i,l;if(!(n.length<f+v-a)){for(i=0;i<f;i++)c=(n[i]-128)/128,e+=c*c;for(o=a;o<=v;o++){for(u=0,i=0;i<f;i++)u+=Math.abs((n[i]-128)/128-(n[i+o]-128)/128);u=1-u/f;u>s&&(s=u,h=o)}if(e=Math.sqrt(e/f),e>.01&&s>.01){if(y=t/h,l={confidence:s,currentPitch:y,fequency:t/h,rms:e,timeStamp:new Date},r.onresult)r.onresult(l);r.analyzerResult.unshift(l)}}}function s(){r.analyser.getByteTimeDomainData(f);o(f,r.audioContext.sampleRate)}var r=this,f=new Uint8Array(2048),u=!1,e;this.analyzerResult=[];this.isSpeaking=!1;this.onResult=undefined;this.onAnalysis=undefined;this.audioContext=new AudioContext;e=this.audioContext.createMediaStreamSource(n);this.analyser=this.audioContext.createAnalyser();this.analyser.smoothingTimeConstant=.8;this.analyser.fftSize=2048;e.connect(this.analyser);this.byteFrequencyData=function(){var n=new Uint8Array(this.analyser.frequencyBinCount);return this.analyser.getByteFrequencyData(n),n};this.enabled=function(n){u=n||!u};window.setInterval(function(){u&&s()},(t||1e3)/10);setInterval(function(){if(u&&r.analyzerResult.length>5){var t=new Date,n=r.analyzerResult[0],i=new Date(r.analyzerResult[0].timeStamp.getTime());if(t-i>1e3){if(r.isSpeaking){if(n.isSpeaking=!1,r.onanalysis)r.onanalysis(n);r.analyzerResult=[]}r.isSpeaking=!1}else{if(!r.isSpeaking&&(n.isSpeaking=!0,r.onanalysis))r.onanalysis(n);r.isSpeaking=!0}}},250);i&&i()}return n}();XSockets.WebRTC=function(n,t){var e=!1,r=this,u=[],o=new XSockets.Subscriptions,c,f,s,h;this.PeerConnections={};this.DataChannels=undefined;c={iceServers:[{url:"stun:stun.l.google.com:19302"}],sdpConstraints:{optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},streamConstraints:{mandatory:{},optional:[]},sdpExpressions:[]};f=XSockets.Utils.extend(c,t);this.bind=function(n,t,i,r){return o.add(n,t),r&&typeof r=="function"&&r(),this};this.unbind=function(n,t){return o.remove(n),t&&typeof t=="function"&&t(),this};this.dispatch=function(n,t){var i="on"+n;(this.hasOwnProperty(i)&&r[i](t),o.get(n)!==null)&&(typeof t=="string"&&(t=JSON.parse(t)),o.fire(n,t,function(){}))};this.muteAudio=function(n){u.forEach(function(n){var t=n.getAudioTracks();if(t.length!==0)if(e)for(i=0;i<t.length;i++)t[i].enabled=!0;else for(i=0;i<t.length;i++)t[i].enabled=!1});e=!e;n&&n(e)};this.hasStream=function(){return u.length>0};this.leaveContext=function(){return n.publish("leaveContext",{}),this};this.changeContext=function(t){n.publish("changecontext",{context:t});for(var i in this.PeerConnections)this.PeerConnections[i].Connection.close(),delete this.PeerConnections[i];return this};this.connect=function(){for(var t in this.PeerConnections)this.PeerConnections[t].Connection.close(),delete this.PeerConnections[t];return n.publish("connect"),this};this.getLocalStreams=function(){return u};this.removeStream=function(t,i){u.forEach(function(f,e){if(f.id===t){u[e].stop();u.splice(e,1);for(var o in r.PeerConnections)n.publish("removestream",{recipient:o,streamId:t}),i&&i(t)}})};this.userMediaConstraints={qvga:function(n){return{video:{mandatory:{maxWidth:320,maxHeight:180}},audio:typeof n!="boolean"?!1:n}},vga:function(n){return{video:{mandatory:{maxWidth:640,maxHeight:360}},audio:typeof n!="boolean"?!1:n}},hd:function(n){return{video:{mandatory:{minWidth:1280,minHeight:720}},audio:typeof n!="boolean"?!1:n}},create:function(n,t,i){return{video:{mandatory:{minWidth:n,minHeight:t}},audio:typeof i!="boolean"?!1:i}},screenSharing:function(){return{video:{mandatory:{chromeMediaSource:"screen"}}}}};this.getRemotePeers=function(){var n=[];for(var t in r.PeerConnections)n.push(t);return n};this.refreshStreams=function(n,t){u.forEach(function(t,i){r.PeerConnections[n].Connection.removeStream(u[i])});h({PeerId:n});t&&t(n)};this.addLocalStream=function(t,i){var f=u.push(t);return n.trigger("AddStream",{streamId:t.id,description:""}),r.dispatch(XSockets.WebRTC.Events.onlocalStream,t),i&&i(t,f),this};this.removePeerConnection=function(n,t){if(r.PeerConnections[n]!==undefined)try{r.PeerConnections[n].Connection.close();r.dispatch(XSockets.WebRTC.Events.onPeerConnectionLost,{PeerId:n})}catch(i){}delete r.PeerConnections[n];t&&t()};this.getUserMedia=function(t,i,f){return window.getUserMedia(t,function(t){u.push(t);n.trigger("AddStream",{streamId:t.id,description:""});r.dispatch(XSockets.WebRTC.Events.onlocalStream,t);i&&typeof i=="function"&&i(r.CurrentContext)},function(n){f&&typeof f=="function"&&f(n)}),this};this.addDataChannel=function(n){if(this.DataChannels=this.DataChannels||{},this.DataChannels.hasOwnProperty(n.name))throw"A RTCDataChannel named '"+n.Name+"' already exists and cannot be created.";else this.DataChannels[n.name]=n};this.removeDataChannel=function(n){if(this.DataChannels.hasOwnProperty(n)){delete this.DataChannels[n];for(var t in this.PeerConnections)this.PeerConnections[t].RTCDataChannels[n].close(),delete this.PeerConnections[t].RTCDataChannels[n]}else throw"A RTCDataChannel named '"+n+"' does not exists.";};s=function(t,i){var f=this,e,o,u;this.PeerId=i;this.RTCDataChannels={};e={};(webrtcDetectedBrowser==="chrome"&&webrtcDetectedVersion<=31||webrtcDetectedBrowser==="firefox")&&typeof r.DataChannels=="object"&&t.sdpConstraints.optional.push({RtpDataChannels:!0});this.Connection=new RTCPeerConnection({iceServers:t.iceServers},null);this.Connection.oniceconnectionstatechange=function(){};this.Connection.onnegotiationneeded=function(){};this.Connection.onremovestream=function(){};this.Connection.onsignalingstatechange=function(){};for(o in r.DataChannels)u=r.DataChannels[o],this.RTCDataChannels[u.name]=this.Connection.createDataChannel(u.name,t.dataChannelConstraints),this.Connection.ondatachannel=function(n){var t=n.channel;t.onmessage=function(n){var t=JSON.parse(n.data).JSON;u.subscriptions.fire(t.event,{peerId:f.PeerId,message:JSON.parse(t.data)},function(){})};t.onopen=function(n){if(u.onopen)u.onopen(f.PeerId,n.target)};t.onclose=function(n){if(u.onclose)u.onclose(f.PeerId,n.target)};e[n.label]=n.channel},u.onpublish=function(n,t){var f=new XSockets.Message(n,t);for(var i in r.PeerConnections)r.PeerConnections[i].RTCDataChannels[u.name].readyState==="open"&&r.PeerConnections[i].RTCDataChannels[u.name].send(JSON.stringify(f))},u.onpublishTo=function(n,t,i){var f=new XSockets.Message(t,i);r.PeerConnections[n]&&r.PeerConnections[n].RTCDataChannels[u.name].send(JSON.stringify(f))};this.Connection.onaddstream=function(n){r.dispatch(XSockets.WebRTC.Events.onRemoteStream,{PeerId:f.PeerId,stream:n.stream})};this.Connection.onicecandidate=function(t){if(t.candidate){var i={type:"candidate",label:t.candidate.sdpMLineIndex,id:t.candidate.sdpMid,candidate:t.candidate.candidate};n.publish("contextsignal",{sender:r.CurrentContext.PeerId,recipient:f.PeerId,message:JSON.stringify(i)})}};r.dispatch(XSockets.WebRTC.Events.onPeerConnectionCreated,{PeerId:f.PeerId})};h=function(t){t&&(r.PeerConnections[t.PeerId]=new s(f,t.PeerId),u.forEach(function(n){r.PeerConnections[t.PeerId].Connection.addStream(n,f.streamConstraints)}),r.PeerConnections[t.PeerId].Connection.createOffer(function(i){f.sdpExpressions.forEach(function(n){i.sdp=n(i.sdp)},function(n){console.log(n)});r.PeerConnections[t.PeerId].Connection.setLocalDescription(i);n.publish("contextsignal",{Sender:r.CurrentContext.PeerId,Recipient:t.PeerId,Message:JSON.stringify(i)})},null,f.sdpConstraints))};r.bind("connect",function(n){h(n)});r.bind("candidate",function(n){var t=JSON.parse(n.Message);r.PeerConnections[n.Sender]&&r.PeerConnections[n.Sender].Connection.addIceCandidate(new RTCIceCandidate({sdpMLineIndex:t.label,candidate:t.candidate}))});r.bind("answer",function(n){r.dispatch(XSockets.WebRTC.Events.onAnswer,{PeerId:n.Sender});r.PeerConnections[n.Sender].Connection.setRemoteDescription(new RTCSessionDescription(JSON.parse(n.Message)))});r.bind("offer",function(t){r.dispatch(XSockets.WebRTC.Events.onOffer,{PeerId:t.Sender});r.PeerConnections[t.Sender]=new s(f,t.Sender);r.PeerConnections[t.Sender].Connection.setRemoteDescription(new RTCSessionDescription(JSON.parse(t.Message)));u.forEach(function(n){r.PeerConnections[t.Sender].Connection.addStream(n,f.streamConstraints)});r.PeerConnections[t.Sender].Connection.createAnswer(function(i){r.PeerConnections[t.Sender].Connection.setLocalDescription(i);f.sdpExpressions.forEach(function(n){i.sdp=n(i.sdp)},function(){});var u={Sender:r.CurrentContext.PeerId,Recipient:t.Sender,Message:JSON.stringify(i)};n.publish("contextsignal",u)},null,f.sdpConstraints)});n.subscribe("contextcreated",function(n){r.CurrentContext=new XSockets.PeerContext(n.PeerId,n.Context);r.dispatch(XSockets.WebRTC.Events.onContextCreated,n)},function(){n.publish("getContext")});n.subscribe("contextsignal",function(n){var t=JSON.parse(n.Message);r.dispatch(t.type,n)});n.subscribe("contextchanged",function(n){r.dispatch(XSockets.WebRTC.Events.onContextChange,n)});n.subscribe("contextconnect",function(n){n.forEach(function(n){r.dispatch("connect",n);r.dispatch(XSockets.WebRTC.Events.onPeerConnectionStarted,n)})});n.subscribe("peerconnectiondisconnect",function(n){r.PeerConnections[n.Sender]!==undefined&&(r.PeerConnections[n.Sender].Connection.close(),r.dispatch(XSockets.WebRTC.Events.onPeerConnectionLost,{PeerId:n.Sender}),delete r.PeerConnections[n.Sender])});n.subscribe("streamadded",function(n){r.dispatch(XSockets.WebRTC.Events.onLocalStreamCreated,n)});n.subscribe("streamremoved",function(n){r.dispatch(XSockets.WebRTC.Events.onRemoteStreamLost,{PeerId:n.Sender,StreamId:n.StreamId})});n.subscribe("peerconnectionlost",function(n){r.dispatch(XSockets.WebRTC.Events.onPeerConnectionLost,{PeerId:n.PeerId});r.PeerConnections[n.PeerId]!==undefined&&(r.PeerConnections[n.PeerId].Connection.close(),delete r.PeerConnections[n.PeerId])})};XSockets.WebRTC.DataChannel=function(){function n(n){var t=this;this.subscriptions=new XSockets.Subscriptions;this.name=n;this.subscribe=function(n,i){t.subscriptions.add(n,i)};this.publish=function(n,i,r){if(t.onpublish){t.onpublish(n,i);r&&r(i)}};this.publishTo=function(){};this.unsubscribe=function(n,i){t.subscriptions.remove(n);i&&i()};this.onbinary=undefined;this.onpublish=undefined;this.onclose=undefined;this.onopen=undefined}return n}();XSockets.WebRTC.CallManager=function(n,t){var i=t.events;this.call=function(t){n.trigger("offercontext",{PeerId:t.PeerId})};this.acceptCall=function(n){i.onAcceptCall(n)};this.denyCall=function(t){n.trigger("denycontext",{PeerId:t.PeerId})};this.endCall=function(){n.trigger("leavecontext",{})};n.subscribe("contextoffer",i.onCall);n.subscribe("contextdeny",i.onDenyCall)};XSockets.WebRTC.Events={onlocalStream:"localstream",onRemoteStream:"remotestream",onRemoteStreamLost:"removestream",onLocalStreamCreated:"streamadded",onContextChange:"contextchanged",onContextCreated:"contextcreated",onPeerConnectionStarted:"peerconnectionstarted",onPeerConnectionCreated:"peerconnectioncreated",onPeerConnectionLost:"peerconnectionlost",onDataChannelOpen:"datachannelopen",onDataChannelClose:"datachannelclose",onOffer:"sdoffer",onAnswer:"sdanswer"};
/*
//# sourceMappingURL=XSockets.WebRTC.latest.min.js.map
*/